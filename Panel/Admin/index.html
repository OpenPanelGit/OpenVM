<!DOCTYPE html>
<html>

<head>
    <title>OpenWin | Admin Area</title>
    <link rel="stylesheet" href="/shared/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div class="layout">
        <div class="sidebar">
            <h2 style="margin-bottom: 30px;">Admin CP</h2>
            <nav>
                <a href="/user-panel" class="nav-item">Dashboard Client</a>
                <a href="#" class="nav-item active" id="nav-vms" onclick="showView('vms')">Gestion VMs</a>
                <a href="#" class="nav-item" id="nav-users" onclick="showView('users')">Utilisateurs</a>
                <a href="#" class="nav-item" id="nav-nodes" onclick="showView('nodes')">Noeuds / Nodes</a>
            </nav>
        </div>
        <main class="main">
            <!-- VMs View -->
            <div id="view-vms" class="content-view">
                <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                    <h1>Gestion des Instances</h1>
                    <button class="btn btn-primary" onclick="toggleCreateVM()">+ Nouvelle Instance</button>
                </header>

                <div id="createVM" class="card" style="display:none; margin-bottom:40px;">
                    <h2>Cr√©er une nouvelle VM Windows/Linux</h2>
                    <form id="createForm"
                        style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
                        <div>
                            <label>Nom de la VM</label>
                            <input type="text" name="name" placeholder="client-vps-01" required>
                        </div>
                        <div>
                            <label>VCPUs</label>
                            <input type="number" name="cpu" value="2" required>
                        </div>
                        <div>
                            <label>RAM (MB)</label>
                            <input type="number" name="ram" value="4096" required>
                        </div>
                        <div>
                            <label>Syst√®me d'exploitation</label>
                            <select name="osType"
                                style="width:100%; padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:white; margin-top:8px;">
                                <option value="windows">Windows (RDP)</option>
                                <option value="ubuntu">Ubuntu / Linux (SSH)</option>
                            </select>
                        </div>
                        <div>
                            <label>Disque (GB)</label>
                            <input type="number" name="disk" value="50" required>
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Mot de passe Root (pour Auto-Setup Linux)</label>
                            <input type="text" name="password"
                                placeholder="Le mot de passe que tu as mis pendant l'install" value="password123">
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Chemin ISO Windows/Linux</label>
                            <input type="text" name="iso" placeholder="C:\path\to\os.iso">
                        </div>
                        <div style="grid-column: span 2;">
                            <button type="submit" class="btn btn-primary">Lancer la cr√©ation</button>
                            <button type="button" class="btn btn-outline" onclick="toggleCreateVM()">Annuler</button>
                        </div>
                    </form>
                </div>
                <div id="vmList"></div>
            </div>

            <!-- Users View -->
            <div id="view-users" class="content-view" style="display:none;">
                <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                    <h1>Utilisateurs</h1>
                    <button class="btn btn-primary" onclick="toggleCreateUser()">+ Nouveau Compte</button>
                </header>

                <div id="createUser" class="card" style="display:none; margin-bottom:40px;">
                    <h2>Ajouter un utilisateur</h2>
                    <form id="userForm" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
                        <div>
                            <label>Nom d'utilisateur</label>
                            <input type="text" name="username" required>
                        </div>
                        <div>
                            <label>Mot de passe</label>
                            <input type="password" name="password" required>
                        </div>
                        <div>
                            <label>R√¥le</label>
                            <select name="role">
                                <option value="user">Utilisateur standard</option>
                                <option value="admin">Administrateur</option>
                            </select>
                        </div>
                        <div style="grid-column: span 2;">
                            <button type="submit" class="btn btn-primary">Cr√©er le compte</button>
                        </div>
                    </form>
                </div>
                <div id="userList"></div>
            </div>

            <!-- Nodes View -->
            <div id="view-nodes" class="content-view" style="display:none;">
                <header style="margin-bottom:40px;">
                    <h1>Configuration des Noeuds</h1>
                </header>
                <div id="nodeInfo" class="card">
                    <h3>Noeud Principal (Local)</h3>
                    <div id="nodeStats"
                        style="margin-top:20px; display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
                        <!-- Stats here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/user-panel';

        function showView(view) {
            document.querySelectorAll('.content-view').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + view).style.display = 'block';
            document.getElementById('nav-' + view).classList.add('active');

            if (view === 'vms') fetchVms();
            if (view === 'users') fetchUsers();
            if (view === 'nodes') fetchNodeInfo();
        }

        function toggleCreateVM() {
            const div = document.getElementById('createVM');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function toggleCreateUser() {
            const div = document.getElementById('createUser');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        async function deleteVM(name) {
            if (!confirm(`üí£ Supprimer d√©finitivement la VM ${name} ?\n(Cette action supprimera aussi le disque dur virtuel !)`)) return;
            try {
                const r = await fetch('/api/admin/vms/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name })
                });
                const res = await r.json();
                if (res.error) {
                    alert("‚ùå ERREUR : " + res.error);
                } else {
                    alert("‚úÖ VM '" + name + "' supprim√©e avec succ√®s.");
                    fetchVms();
                }
            } catch (err) {
                alert("‚ùå Erreur de connexion au serveur : " + err.message);
            }
        }

        async function fetchVms() {
            const r = await fetch('/api/vms', { headers: { 'Authorization': `Bearer ${token}` } });
            const vms = await r.json();
            const list = document.getElementById('vmList');
            list.innerHTML = vms.map(vm => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${vm.name}</strong> <span style="font-size:0.7rem; color:var(--text-muted)">(${vm.os})</span><br>
                        <small style="color:${vm.status === 'running' ? 'var(--success)' : 'var(--danger)'}">Status: ${vm.status}</small>
                    </div>
                    <div><button class="btn btn-outline" style="color:var(--danger)" onclick="deleteVM('${vm.name}')">Supprimer</button></div>
                </div>
            `).join('') || '<p>Aucune VM trouv√©e.</p>';
        }

        async function fetchUsers() {
            const r = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${token}` } });
            const users = await r.json();
            const list = document.getElementById('userList');
            list.innerHTML = users.map(u => `
                <div class="card" style="display:flex; justify-content:space-between;">
                    <div>
                        <strong>${u.username}</strong><br>
                        <small style="color:var(--text-muted)">ID: ${u.id} | Role: ${u.role}</small>
                    </div>
                    <div><button class="btn btn-outline">G√©rer</button></div>
                </div>
            `).join('');
        }

        async function fetchNodeInfo() {
            const r = await fetch('/api/admin/node-info', { headers: { 'Authorization': `Bearer ${token}` } });
            const info = await r.json();
            const stats = document.getElementById('nodeStats');
            stats.innerHTML = `
                <div class="card" style="text-align:center;"><strong>OS</strong><br>${info.os}</div>
                <div class="card" style="text-align:center;"><strong>CPUs</strong><br>${info.cpus}</div>
                <div class="card" style="text-align:center;"><strong>RAM Totale</strong><br>${info.totalMemory}</div>
                <div class="card" style="text-align:center;"><strong>RAM Libre</strong><br>${info.freeMemory}</div>
                <div class="card" style="text-align:center;"><strong>Arch</strong><br>${info.arch}</div>
                <div class="card" style="text-align:center;"><strong>Node Uptime</strong><br>${info.uptime}</div>
            `;
        }

        document.getElementById('createForm').onsubmit = async (e) => {
            e.preventDefault();
            const r = await fetch('/api/admin/vms/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(Object.fromEntries(new FormData(e.target)))
            });
            const res = await r.json();
            if (res.error) {
                alert("‚ùå √âCHEC : " + res.error);
            } else {
                alert("‚ú® VM cr√©√©e avec succ√®s ! Elle va appara√Ætre dans la liste.");
                toggleCreateVM();
                fetchVms();
            }
        };

        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/api/admin/users/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(Object.fromEntries(new FormData(e.target)))
            });
            toggleCreateUser();
            fetchUsers();
        };

        showView('vms');
        lucide.createIcons();
    </script>
</body>

</html>